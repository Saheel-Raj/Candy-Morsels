<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Candy Morsels</title>
    <style>
        body {
            background: url('https://static.vecteezy.com/system/resources/thumbnails/003/235/083/original/candyland-cartoon-background-free-video.jpg') center center / cover no-repeat fixed;
            font-family: 'Segoe UI', Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            min-height: 100vh;
        }

        h1 {
            margin-top: 1.5rem;
            font-weight: 900;
            font-size: 2.5rem;
            background: linear-gradient(90deg, #ff6a00, #ee0979);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: 2px;
            text-shadow: 2px 2px #fff3;
        }

        #score,
        #timer {
            font-size: 1.2rem;
            font-weight: bold;
            padding: 8px 16px;
            border-radius: 12px;
            margin: 0.5rem;
            display: inline-block;
        }

        #score {
            background: #d1f7c4;
            color: #2d6a4f9f;
        }

        #timer {
            background: #ffe3e3;
            color: #d90427a3;
        }

        .box {
            padding: 8px;
            box-shadow: 0 8px 28px rgba(78, 168, 222, 0.10);
            background: linear-gradient(90deg, #bccbf6 0%, #bccbf6 50%, #c69ef2 100%);
            border-radius: 20px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 4px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 18px;
            padding: 6px;
            box-shadow: inset 0 0 12px rgba(0, 0, 0, 0.15);
            width: 90vw;
            max-width: 450px;
            aspect-ratio: 1 / 1;
            position: relative;
            overflow: hidden;
        }

        .restart {
            margin-top: 15px;
            padding: 10px 18px;
            color: #fff;
            background-color: #f83122;
            text-decoration: none;
            font-size: 18px;
            border-radius: 10px;
            cursor: pointer;
        }

        .candy {
            width: 100%;
            aspect-ratio: 1 / 1;
            border-radius: 10px;
            background-size: cover;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .candy:active {
            transform: scale(1.1) translateY(1px);
        }

        .candy.pop {
            animation: pop 420ms forwards;
        }

        .candy.dragging {
            outline: 3px dashed #ffcc00;
            transform: scale(1.15);
        }

        @keyframes pop {
            0% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.4);
                opacity: 0.9;
            }

            100% {
                transform: scale(0);
                opacity: 0;
            }
        }

        /* Floating score animation */
        .float-score {
            position: absolute;
            font-size: 1.2rem;
            font-weight: bold;
            animation: floatUp 1.2s ease-out forwards;
            pointer-events: none;
            text-shadow: 1px 1px 4px #fff;
        }

        @keyframes floatUp {
            0% {
                opacity: 1;
                transform: translateY(0);
            }

            100% {
                opacity: 0;
                transform: translateY(-50px);
            }
        }

        footer {
            margin-top: auto;
            text-align: center;
            color: #000;
            padding: 10px;
            font-size: 14px;
        }

        .popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            visibility: hidden;
        }

        .popup.show {
            visibility: visible;
        }

        .popup-content {
            background: #fff;
            padding: 20px 30px;
            border-radius: 12px;
            text-align: center;
            max-width: 300px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
        }

        .popup-content h2 {
            margin: 0 0 10px;
            color: #4ea8de;
        }

        .popup-content button {
            margin-top: 10px;
            padding: 8px 14px;
            background: #f83122;
            border: none;
            border-radius: 8px;
            color: #fff;
            font-size: 16px;
            cursor: pointer;
        }

        @media (max-width: 500px) {
            h1 {
                font-size: 1.8rem;
            }

            #score,
            #timer {
                font-size: 1rem;
                padding: 6px 10px;
            }

            .restart a {
                font-size: 16px;
                padding: 10px 16px;
            }
        }
    </style>
</head>

<body>
    <h1>Candy Morsels</h1>
    <div id="score">Score: 0</div>
    <div id="timer">Time Left: 60s</div>
    <div class="box">
        <div class="grid" id="grid"></div>
    </div>
    <div class="restart"><a onclick="window.location.reload()">Restart</a></div>
    <footer>Coded by Saheel Raj Prasad X'D'</footer>

    <div id="introPopup" class="popup">
        <div class="popup-content">
            <h2>How to Play</h2>
            <p>Match 3 or more candies by swapping adjacent ones.<br>
                Click, drag, or swipe to swap! <br> Highest score by Saheel (Developer) 940 â€” try to beat me!</p>
        </div>
    </div>

    <div id="gameOverPopup" class="popup">
        <div class="popup-content">
            <h2>Game Over!</h2>
            <p id="finalScore">Your score: 0</p>
            <button onclick="window.location.reload()">Play Again</button>
        </div>
    </div>

    <audio id="bgMusic" loop></audio>
    <audio id="removeSound" src="blkremo.mp3"></audio>
    <audio id="comboSound" src="delicious.mp3"></audio>

    <script>
        const grid = document.getElementById('grid');
        const scoreDisplay = document.getElementById('score');
        const timerDisplay = document.getElementById('timer');
        const width = 8;
        const candyImages = ['red.png', 'blue.png', 'yellow.png', 'green.png', 'purple.png'];
        let squares = [];
        let score = 0;
        let selectedCandy = null;
        let timeLeft = 60;

        const themes = ["theme1.mp3", "theme2.mp3"];
        const bgMusic = document.getElementById("bgMusic");
        bgMusic.src = themes[Math.floor(Math.random() * themes.length)];
        bgMusic.volume = 0.8;

        const removeSound = document.getElementById("removeSound");
        const comboSound = document.getElementById("comboSound");

        function createBoard() {
            for (let i = 0; i < width * width; i++) {
                const square = document.createElement('div');
                square.classList.add('candy');
                square.setAttribute('data-id', i);
                square.style.backgroundImage = `url(${getValidCandy(i)})`;
                grid.appendChild(square);
                squares.push(square);
            }
            checkMatches();
        }

        function getRandomCandy() {
            return candyImages[Math.floor(Math.random() * candyImages.length)];
        }

        function getValidCandy(index) {
            let candy;
            do {
                candy = getRandomCandy();
            } while (createsMatch(index, candy));
            return candy;
        }

        function createsMatch(index, candy) {
            const col = index % width;
            if (col >= 2 &&
                candy === squares[index - 1]?.style.backgroundImage &&
                candy === squares[index - 2]?.style.backgroundImage) return true;
            if (index >= width * 2 &&
                candy === squares[index - width]?.style.backgroundImage &&
                candy === squares[index - width * 2]?.style.backgroundImage) return true;
            return false;
        }

        function handleCandyClick(e) {
            const clickedCandy = e.target;
            const clickedIndex = parseInt(clickedCandy.getAttribute('data-id'));
            if (!selectedCandy) {
                selectedCandy = clickedCandy;
                selectedCandy.style.outline = '3px solid #b352d1';
            } else {
                const selectedIndex = parseInt(selectedCandy.getAttribute('data-id'));
                if (isAdjacent(selectedIndex, clickedIndex)) swapCandies(selectedCandy, clickedCandy);
                selectedCandy.style.outline = '';
                selectedCandy = null;
            }
        }

        function isAdjacent(i1, i2) {
            return Math.abs(i1 - i2) === 1 || Math.abs(i1 - i2) === width;
        }

        function swapCandies(c1, c2) {
            const temp = c1.style.backgroundImage;
            c1.style.backgroundImage = c2.style.backgroundImage;
            c2.style.backgroundImage = temp;
            if (!checkMatches()) {
                c2.style.backgroundImage = c1.style.backgroundImage;
                c1.style.backgroundImage = temp;
            }
        }

        // Floating score animation + combo colors
        function showFloatingScore(points, indices) {
            const avgIndex = indices[Math.floor(indices.length / 2)];
            const candy = squares[avgIndex];
            const rect = candy.getBoundingClientRect();
            const gridRect = grid.getBoundingClientRect();

            const float = document.createElement('div');
            float.classList.add('float-score');
            float.textContent = `+${points}`;
            if (points === 10) float.style.color = "#00b4d8";
            else if (points === 15) float.style.color = "#ffb703";
            else if (points === 20) float.style.color = "#ff006e";

            float.style.left = `${rect.left - gridRect.left + rect.width / 2 - 10}px`;
            float.style.top = `${rect.top - gridRect.top}px`;
            grid.appendChild(float);
            setTimeout(() => float.remove(), 1200);
        }

        // Updated scoring and combo sound
        function checkMatches() {
            let matchedGroups = [];

            for (let i = 0; i < width * width; i++) {
                const candy = squares[i].style.backgroundImage;

                if (i % width < width - 2 && candy &&
                    candy === squares[i + 1]?.style.backgroundImage &&
                    candy === squares[i + 2]?.style.backgroundImage) {
                    let group = [i, i + 1, i + 2];
                    let next = i + 3;
                    while (next % width !== 0 && squares[next]?.style.backgroundImage === candy) {
                        group.push(next);
                        next++;
                    }
                    matchedGroups.push(group);
                }

                if (i < width * (width - 2) && candy &&
                    candy === squares[i + width]?.style.backgroundImage &&
                    candy === squares[i + width * 2]?.style.backgroundImage) {
                    let group = [i, i + width, i + width * 2];
                    let next = i + width * 3;
                    while (next < width * width && squares[next]?.style.backgroundImage === candy) {
                        group.push(next);
                        next += width;
                    }
                    matchedGroups.push(group);
                }
            }

            if (matchedGroups.length > 0) {
                let uniqueIndices = [...new Set(matchedGroups.flat())];
                let count = uniqueIndices.length;
                let points = 10;
                if (count === 4) points = 15;
                else if (count > 4) points = 20;

                if (points >= 15) {
                    comboSound.currentTime = 0;
                    comboSound.play();
                }

                score += points;
                scoreDisplay.textContent = `Score: ${score}`;
                showFloatingScore(points, uniqueIndices);
                clearCandies(uniqueIndices);

                setTimeout(() => {
                    dropCandies();
                    setTimeout(checkMatches, 300);
                }, 300);
                return true;
            }
            return false;
        }

        function clearCandies(indices) {
            indices.forEach(i => {
                squares[i].classList.add('pop');
                setTimeout(() => {
                    squares[i].style.backgroundImage = '';
                    squares[i].classList.remove('pop');
                    removeSound.currentTime = 0;
                    removeSound.play();
                }, 300);
            });
        }

        function dropCandies() {
            let moved = false;
            for (let i = width * (width - 1) - 1; i >= 0; i--) {
                if (squares[i + width]?.style.backgroundImage === '') {
                    squares[i + width].style.backgroundImage = squares[i].style.backgroundImage;
                    squares[i].style.backgroundImage = '';
                    moved = true;
                }
            }
            for (let i = 0; i < width; i++) {
                if (squares[i].style.backgroundImage === '') {
                    squares[i].style.backgroundImage = `url(${getRandomCandy()})`;
                    moved = true;
                }
            }
            if (moved) setTimeout(dropCandies, 80);
        }

        function startTimer() {
            const timerInterval = setInterval(() => {
                timeLeft--;
                timerDisplay.textContent = `Time Left: ${timeLeft}s`;
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    showGameOverPopup();
                }
            }, 1000);
        }

        function showIntroPopup() {
            if (!localStorage.getItem("introShown")) {
                const intro = document.getElementById("introPopup");
                intro.classList.add("show");
                setTimeout(() => {
                    intro.classList.remove("show");
                    localStorage.setItem("introShown", "true");
                }, 5000);
            }
        }

        function showGameOverPopup() {
            const gameOver = document.getElementById("gameOverPopup");
            document.getElementById("finalScore").textContent = `Your score: ${score}`;
            gameOver.classList.add("show");
        }

        createBoard();
        squares.forEach(s => s.addEventListener('click', handleCandyClick));

        // Drag & Swipe + touch
        let dragStartId = null;
        squares.forEach(square => {
            square.setAttribute('draggable', true);
            square.addEventListener('dragstart', e => {
                dragStartId = e.target.getAttribute('data-id');
                e.target.classList.add('dragging');
            });
            square.addEventListener('dragend', e => e.target.classList.remove('dragging'));
            square.addEventListener('dragover', e => e.preventDefault());
            square.addEventListener('drop', e => {
                const dragEndId = e.target.getAttribute('data-id');
                if (isAdjacent(parseInt(dragStartId), parseInt(dragEndId)))
                    swapCandies(squares[dragStartId], squares[dragEndId]);
                dragStartId = null;
            });

            let startX, startY;
            square.addEventListener('touchstart', e => {
                dragStartId = e.target.getAttribute('data-id');
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
                e.target.classList.add('dragging');
            }, { passive: false });
            square.addEventListener('touchmove', e => e.preventDefault(), { passive: false });
            square.addEventListener('touchend', e => {
                const startIndex = parseInt(dragStartId);
                e.target.classList.remove('dragging');
                if (!dragStartId) return;
                let endX = e.changedTouches[0].clientX;
                let endY = e.changedTouches[0].clientY;
                let dx = endX - startX;
                let dy = endY - startY;
                let dragEndId = null;
                if (Math.abs(dx) > Math.abs(dy)) {
                    if (dx > 0 && startIndex % width < width - 1) dragEndId = startIndex + 1;
                    else if (dx < 0 && startIndex % width > 0) dragEndId = startIndex - 1;
                } else {
                    if (dy > 0 && startIndex < width * (width - 1)) dragEndId = startIndex + width;
                    else if (dy < 0 && startIndex >= width) dragEndId = startIndex - width;
                }
                if (dragEndId !== null && isAdjacent(startIndex, dragEndId))
                    swapCandies(squares[startIndex], squares[dragEndId]);
                dragStartId = null;
            }, { passive: false });
        });

        // Music plays on first click/touch
        function enableMusicOnce() {
            bgMusic.play().catch(() => { });
            document.removeEventListener("click", enableMusicOnce);
            document.removeEventListener("touchstart", enableMusicOnce);
        }
        document.addEventListener("click", enableMusicOnce);
        document.addEventListener("touchstart", enableMusicOnce);

        window.addEventListener("load", showIntroPopup);
        startTimer();


        // made by saheel
    </script>
</body>

</html>
